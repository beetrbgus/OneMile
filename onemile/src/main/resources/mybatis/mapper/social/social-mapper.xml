<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="social">
	<!-- 승인 등록 -->

	<insert id="reg" parameterType="SocialDTO">
		insert into SOCIAL(
			SOCIAL_NO ,MEMBER_NO ,MAP_NO ,SMALLTYPE ,TITLE,
			CONTEXT,STARTDATE,ENDDATE,MINPEOPLE,MAXPEOPLE
		) values(
			#{socialNo},#{memberNo},#{mapNo},#{smalltype},
			#{title},#{context},#{startDate},#{endDate},
			#{minpeople},#{maxpeople}
		)
	</insert>
		
	<!-- 상세정보 -->
	<select id="getDetail" parameterType="int" resultMap="socialDetail">
		select * from social s 
		    inner join map m on s.map_no = m.map_no
		    inner join mei on mei.member_no = s.member_no
		    inner join smc on s.smalltype = smc.SMALLTYPE    
		where social_no = #{socialNo} and s.hiddenyn= 'N'
	</select>
	<!-- 참가자 목록 가져오기 -->
	<select id="getparticipate" parameterType="int" resultType="ParticipateVO">
		select m.member_No, m.nick, m.intro , mei.IMAGE_NO 
		    from SP  inner join member m on sp.member_no = m.member_no
			inner join mei on sp.member_no = mei.member_no
		where SOCIAL_NO = #{SOCIAL_NO}
	</select>
	<select id="getDetailimage" parameterType="int" resultType="ImageDTO">
		select * from SMI inner join image 
			img on smi.image_no = img.image_no
		where SOCIAL_NO = #{SOCIAL_NO}
	</select>
	<!-- Detail ResultMap -->
	<resultMap type="SocialDetailVO" id="socialDetail">
		<result column="SOCIAL_NO" property="socialNo" />
		<result column="TITLE" property="title" />
		<result column="LARGE_NAME" property="type" />
		<result column="MIDDLE_NAME" property="smalltype" />
		<result column="STARTDATE" property="starDate" />
		<result column="ENDDATE" property="endDate" />
		<result column="CONTEXT" property="context" />
		<result column="IMAGE_NO" property="profileImgNo" />
		<result column="MINPEOPLE" property="minpeople" />
		<result column="MAXPEOPLE" property="maxpeople" />
		<result column="MEMBER_NO" property="memberNo" />
		
		<result column="REGDATE" property="regdate" />
		
		<result column="MAP_NO" property="mapNo" />
		<result column="LAT" property="lat" />
		<result column="LNG" property="lng" />
		<result column="DETAILADDRESS" property="detailAddress" />
		
		<collection property="participate" javaType="java.util.List"
			ofType="ParticipateVO" select="getparticipate" column="member_no"/>
		<collection property="imageInfo" javaType="java.util.List"
			ofType="ImageDTO" select="getDetailimage" column="social_no"/>
		
	</resultMap>
	<!-- List ResultMap -->
	<resultMap type="SocialListVO" id="socialList">
		<result column="IMAGE_NO" property="imgNo" />
		<result column="SOCIAL_NO" property="socialNo" />
		<result column="BIGTYPE" property="type" />
		<result column="SMALLTYPE" property="smalltype" />
		<result column="TITLE" property="title" />
		<result column="STARTDATE" property="startDate" />
		<result column="ENDDATE" property="endDate" />
		<result column="MEMBER_NO" property="memberNo" />
		<result column="NICK" property="nick" />
		<result column="PROFILEIMGNO" property="profileImgNo" />
		<result column="DETAILADDRESS" property="detailAddress" />
	</resultMap>
	
	<select id="getList" parameterType="PaginationVO" resultMap="socialList">
		select * from (
			select rownum rn, TMP.* from (
				select
					s.social_no ,s.smalltype ,s.title,
					TO_CHAR(s.startdate, 'MM/DD HH24:mm') as startDate,
					TO_CHAR(s.enddate, 'MM/DD HH24:mm') as endDate,
					m.member_no,m.nick, mei.image_no as profileImgNo ,
					map.detailaddress , smi.image_no, smc.bigtype
				from social s
					inner join member m on s.member_no=m.member_no
					inner join mei on mei.member_no = m.member_no
					inner join smi on smi.social_no = s.social_no
					inner join map on map.map_no = s.map_no
					inner join smc on s.smalltype = smc.SMALLTYPE
					inner join sbc on smc.bigtype = sbc.BIGTYPE
				where s.hiddenyn ='N' 
			<choose>
				<when test="category !=null and !category.equals('')">
					and sbc.bigValue = #{category} 
				</when>
				<when test="keyword != null and !keyword.equals('') and searchword != null and !searchword.equals('')">
					and #{keyword} = #{searchword}
				</when>
			</choose>
				order by s.social_no desc
			)TMP
		) where rn between #{startRow} and #{endRow}
	</select>
	
	<select id="getCount" parameterType="int" resultType="SocialDTO">
		select * from social where member_no = #{memberNo} and regdate > sysdate-7
	</select>
	
	<select id="randomList" parameterType="PaginationVO" resultType="SocialListVO">
		select * from (
		    select rownum rn, TMP.* from (
		        SELECT * FROM social WHERE hiddenyn = 'N' ORDER BY DBMS_RANDOM.RANDOM
		    )TMP
		) where rn between #{startRow} and #{endRow}
	</select>
</mapper>